class v extends HTMLElement{tocEl=null;visibleClass="visible";observer;anchorNavTarget=null;headingIdxMap=new Map;headings=[];sections=[];tocEntries=[];active=[];activeIndicator=null;constructor(){super(),this.observer=new IntersectionObserver(this.markVisibleSection,{threshold:0})}markVisibleSection=t=>{t.forEach(i=>{const e=i.target.children[0]?.getAttribute("id"),s=e?this.headingIdxMap.get(e):void 0;s!=null&&(this.active[s]=i.isIntersecting),i.isIntersecting&&this.anchorNavTarget==i.target.firstChild&&(this.anchorNavTarget=null)}),this.active.includes(!0)||this.fallback(),this.update()};toggleActiveHeading=()=>{let t=this.active.length-1,i=this.active.length-1,e=-1;for(;t>=0&&!this.active[t];)this.tocEntries[t]&&this.tocEntries[t].classList.remove(this.visibleClass),t--;for(;t>=0&&this.active[t];)this.tocEntries[t]&&(this.tocEntries[t].classList.add(this.visibleClass),i=Math.min(i,t),e=Math.max(e,t)),t--;for(;t>=0;)this.tocEntries[t]&&this.tocEntries[t].classList.remove(this.visibleClass),t--;if(i>e)this.activeIndicator?.setAttribute("style","opacity: 0");else{let s=this.tocEl?.getBoundingClientRect().top||0,o=this.tocEl?.scrollTop||0;const a=this.tocEntries[i],r=this.tocEntries[e];if(a&&r){let l=a.getBoundingClientRect().top-s+o,c=r.getBoundingClientRect().bottom-s+o;this.activeIndicator?.setAttribute("style",`top: ${l}px; height: ${c-l}px`)}}};scrollToActiveHeading=()=>{if(this.anchorNavTarget||!this.tocEl)return;const t=document.querySelectorAll(`#toc .${this.visibleClass}`);if(!t.length)return;const i=t[0],e=t[t.length-1],s=this.tocEl.clientHeight;let o;e.getBoundingClientRect().bottom-i.getBoundingClientRect().top<.9*s?o=i.offsetTop-32:o=e.offsetTop-s*.8,this.tocEl.scrollTo({top:o,left:0,behavior:"smooth"})};update=()=>{requestAnimationFrame(()=>{this.toggleActiveHeading(),this.scrollToActiveHeading()})};fallback=()=>{if(this.sections.length)for(let t=0;t<this.sections.length;t++){let i=this.sections[t].getBoundingClientRect().top,e=this.sections[t].getBoundingClientRect().bottom;if(this.isInRange(i,0,window.innerHeight)||this.isInRange(e,0,window.innerHeight)||i<0&&e>window.innerHeight)this.markActiveHeading(t);else if(i>window.innerHeight)break}};markActiveHeading=t=>{this.active[t]=!0};handleAnchorClick=t=>{const i=t.composedPath().find(e=>e instanceof HTMLAnchorElement);if(i){t.preventDefault();const e=decodeURIComponent(i.hash?.substring(1)),s=document.getElementById(e);if(s){const r=s.getBoundingClientRect().top+window.scrollY-80;window.scrollTo({top:r,behavior:"smooth"})}const o=this.headingIdxMap.get(e);o!==void 0?this.anchorNavTarget=this.headings[o]:this.anchorNavTarget=null}};isInRange(t,i,e){return i<t&&t<e}connectedCallback(){const t=document.querySelector(".custom-md")||document.querySelector(".prose")||document.querySelector(".markdown-content");let i=!1;const e=()=>{i||(i=!0,this.init())};t?(t.addEventListener("animationend",e,{once:!0}),setTimeout(e,300)):(e(),setTimeout(e,300))}init(){if(this.regenerateTOC(),this.tocEl=this,this.tocEl.addEventListener("click",this.handleAnchorClick,{capture:!0}),this.activeIndicator=document.getElementById("active-indicator"),this.tocEntries=Array.from(this.querySelectorAll("a[href^='#']")),this.tocEntries.length!==0){this.sections=new Array(this.tocEntries.length),this.headings=new Array(this.tocEntries.length);for(let t=0;t<this.tocEntries.length;t++){const i=decodeURIComponent(this.tocEntries[t].hash?.substring(1)),e=document.getElementById(i),s=e?.parentElement;e instanceof HTMLElement&&s instanceof HTMLElement&&(this.headings[t]=e,this.sections[t]=s,this.headingIdxMap.set(i,t))}this.active=new Array(this.tocEntries.length).fill(!1),this.sections.forEach(t=>this.observer.observe(t)),this.fallback(),this.update()}}regenerateTOC(t=0){if(!(window.location.pathname.includes("/posts/")||document.querySelector(".custom-md, .markdown-content")!==null)){this.innerHTML="",delete this.dataset.loaded;return}const e=Array.from(document.querySelectorAll("h1, h2, h3, h4, h5, h6")).filter(n=>n.id).map(n=>({depth:parseInt(n.tagName.substring(1)),slug:n.id,text:(n.textContent||"").replace(/#+\s*$/,"")}));if(e.length===0&&t<3){setTimeout(()=>this.regenerateTOC(t+1),120);return}if(e.length===0){this.innerHTML="",delete this.dataset.loaded;return}const s=Math.min(...e.map(n=>n.depth)),o=window.siteConfig||{},a=o.toc?.depth||3,r=o.toc?.useJapaneseBadge||!1;console.log("TOC Config in regenerateTOC:",{siteConfig:o.toc,maxLevel:a,useJapaneseBadge:r});const l=["ア","イ","ウ","エ","オ","カ","キ","ク","ケ","コ","サ","シ","ス","セ","ソ","タ","チ","ツ","テ","ト","ナ","ニ","ヌ","ネ","ノ","ハ","ヒ","フ","ヘ","ホ","マ","ミ","ム","メ","モ","ヤ","ユ","ヨ","ラ","リ","ル","レ","ロ","ワ","ヲ","ン"];let c=1;const d=e.filter(n=>n.depth<s+a).map(n=>{const g=n.depth===s?"":n.depth===s+1?"ml-4":"ml-8";let h="";return n.depth===s?(r&&c-1<l.length?h=l[c-1]:h=c.toString(),c++):n.depth===s+1?h='<div class="transition w-2 h-2 rounded-[0.1875rem] bg-[var(--toc-badge-bg)]"></div>':h='<div class="transition w-1.5 h-1.5 rounded-sm bg-black/5 dark:bg-white/10"></div>',`<a href="#${n.slug}" class="px-2 flex gap-2 relative transition w-full min-h-9 rounded-xl hover:bg-[var(--toc-btn-hover)] active:bg-[var(--toc-btn-active)] py-2">
                    <div class="transition w-5 h-5 shrink-0 rounded-lg text-xs flex items-center justify-center font-bold ${g} ${n.depth===s?"bg-[var(--toc-badge-bg)] text-[var(--btn-content)]":""}">
                        ${h}
                    </div>
                    <div class="transition text-sm ${n.depth<=s+1?"text-50":"text-30"}">${n.text}</div>
                </a>`}).join("");this.innerHTML=d+'<div id="active-indicator" style="opacity: 0" class="-z-10 absolute bg-[var(--toc-btn-hover)] left-0 right-0 rounded-xl transition-all group-hover:bg-transparent border-2 border-[var(--toc-btn-hover)] group-hover:border-[var(--toc-btn-active)] border-dashed"></div>',this.dataset.loaded="true"}disconnectedCallback(){this.sections.forEach(t=>this.observer.unobserve(t)),this.observer.disconnect(),this.tocEl?.removeEventListener("click",this.handleAnchorClick)}}customElements.get("table-of-contents")||customElements.define("table-of-contents",v);

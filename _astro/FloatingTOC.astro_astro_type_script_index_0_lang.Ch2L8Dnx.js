class h{btn;panel;content;wrapper;isOpen=!1;observer=null;headings=[];constructor(){this.btn=document.getElementById("floating-toc-btn"),this.panel=document.getElementById("floating-toc-panel"),this.content=document.getElementById("floating-toc-content"),this.wrapper=document.querySelector(".floating-toc-wrapper"),this.init()}init(){window.addEventListener("scroll",()=>{this.updateProgress(),this.updateActiveHeading()},{passive:!0}),window.addEventListener("resize",()=>{this.updateActiveHeading(),this.updateProgress()},{passive:!0}),this.bindEvents(),this.generateTOC(),this.observeContent(),this.updateProgress()}observeContent(){const t=document.getElementById("post-container");t&&(this.observer=new MutationObserver(()=>{this.generateTOC(),this.updateProgress()}),this.observer.observe(t,{childList:!0,subtree:!0}))}updateProgress(){if(!this.btn)return;const t=window.scrollY||document.documentElement.scrollTop,n=document.documentElement.scrollHeight-document.documentElement.clientHeight,o=n>0?t/n:0,a=this.btn.querySelector(".progress-ring-circle");if(a){const s=a.r.baseVal.value*2*Math.PI,r=Math.max(0,Math.min(s,s-o*s));a.style.strokeDashoffset=r.toString()}}updateActiveHeading(){if(!this.content||this.headings.length===0)return;const t=window.scrollY,n=150;let o=-1;for(let e=0;e<this.headings.length&&this.headings[e].getBoundingClientRect().top+t<t+n;e++)o=e;Array.from(this.content.querySelectorAll(".floating-toc-item")).forEach((e,s)=>{if(s===o){if(e.classList.add("active"),this.isOpen){const r=this.content;if(r){const l=e,c=r.getBoundingClientRect(),i=l.getBoundingClientRect();(i.top<c.top||i.bottom>c.bottom)&&l.scrollIntoView({block:"nearest"})}}}else e.classList.remove("active")})}generateTOC(){const t=document.getElementById("post-container");if(!t){this.wrapper?.classList.add("no-toc");return}const n=t.querySelectorAll("h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]");if(n.length===0){this.wrapper?.classList.add("no-toc"),this.headings=[];return}this.wrapper?.classList.remove("no-toc"),this.headings=[];const o=parseInt(this.wrapper?.dataset.depth||"3"),a=this.wrapper?.dataset.japaneseBadge==="true",e=["ア","イ","ウ","エ","オ","カ","キ","ク","ケ","コ","サ","シ","ス","セ","ソ","タ","チ","ツ","テ","ト","ナ","ニ","ヌ","ネ","ノ","ハ","ヒ","フ","ヘ","ホ"];let s=6;n.forEach(c=>{const i=parseInt(c.tagName[1]);i<s&&(s=i)});let r="",l=0;n.forEach(c=>{const i=parseInt(c.tagName[1]);if(i>=s+o)return;this.headings.push(c);const p=(i-s)*1;let d="";i===s?(l++,d=`<span class="floating-toc-badge">${a&&l-1<e.length?e[l-1]:l.toString()}</span>`):i===s+1?d='<span class="floating-toc-dot"></span>':d='<span class="floating-toc-dot-small"></span>';const g=(c.textContent||"").replace(/#+\s*$/,"");r+=`<a href="#${c.id}" class="floating-toc-item" style="padding-left: ${.5+p}rem" data-level="${i-s}">${d}<span class="floating-toc-text">${g}</span></a>`}),this.content&&(this.content.innerHTML=r),this.updateActiveHeading()}bindEvents(){this.btn?.addEventListener("click",t=>{t.stopPropagation(),this.toggle()}),document.addEventListener("click",t=>{this.isOpen&&!this.wrapper?.contains(t.target)&&this.close()}),this.content?.addEventListener("click",t=>{const n=t.target.closest("a");if(n){t.preventDefault();const o=n.getAttribute("href")?.slice(1);if(o){const a=document.getElementById(o);if(a){const e=a.getBoundingClientRect().top+window.scrollY-80;window.scrollTo({top:e,behavior:"smooth"}),this.close()}}}}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.isOpen&&this.close()}),window.swup&&window.swup.hooks.on("page:view",()=>{setTimeout(()=>this.reinit(),200)})}toggle(){this.isOpen?this.close():this.open()}open(){this.isOpen=!0,this.panel?.classList.add("show"),this.btn?.classList.add("active"),this.wrapper?.classList.add("active")}close(){this.isOpen=!1,this.panel?.classList.remove("show"),this.btn?.classList.remove("active"),this.wrapper?.classList.remove("active")}reinit(){this.observer&&this.observer.disconnect(),this.close(),this.generateTOC(),this.observeContent(),this.updateProgress()}}document.addEventListener("DOMContentLoaded",()=>new h);document.addEventListener("swup:page:view",()=>new h);
